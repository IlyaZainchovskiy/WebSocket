<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <title>Чат на WebSocket</title>
    <style>
        .system-msg { color: gray; font-style: italic; font-size: 0.9em; }
        .user-msg { margin: 5px 0; }
        #status { font-size: 0.8em; margin-left: 10px; }
    </style>
</head>

<body>
    <h2>Чат <span id="status" style="color: red;">(Відключено)</span></h2>
    <div id="chat" style="border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin-bottom: 10px;"></div>
    <input id="message" placeholder="Введіть повідомлення">
    <button onclick="sendMessage()">Надіслати</button>
    <button onclick="requestNotificationPermission()">Увімкнути сповіщення</button>

    <script>
        let socket;
        const chat = document.getElementById('chat');
        const statusSpan = document.getElementById('status');
        const messageInput = document.getElementById('message');

        function requestNotificationPermission() {
            if (Notification.permission !== "granted") {
                Notification.requestPermission();
            }
        }

        function connect() {
            socket = new WebSocket('ws://localhost:3000');

            socket.onopen = () => {
                statusSpan.innerText = "(Підключено)";
                statusSpan.style.color = "green";
                addMessageToChat("З'єднання встановлено", true);
            };

            socket.onmessage = (event) => {
                if (typeof event.data === 'string') {
                    handleMessage(event.data);
                } else {
                    event.data.text().then(text => handleMessage(text));
                }
            };

            socket.onclose = (event) => {
                statusSpan.innerText = "(Відключено. Спроба відновлення...)";
                statusSpan.style.color = "red";
                setTimeout(connect, 3000);
            };

            socket.onerror = (error) => {
                console.error("Помилка WebSocket:", error);
                socket.close(); 
            };
        }

        function handleMessage(text) {
            const isSystem = text.startsWith('>>>') || text.startsWith('<<<');
            addMessageToChat(text, isSystem);

            if (document.hidden && Notification.permission === "granted" && !isSystem) {
                new Notification("Нове повідомлення в чаті", {
                    body: text,
                    icon: "https://cdn-icons-png.flaticon.com/512/134/134914.png" 
                });
            }
        }

        function addMessageToChat(text, isSystem = false) {
            const newMessage = document.createElement('div');
            newMessage.innerText = text;
            newMessage.className = isSystem ? 'system-msg' : 'user-msg';
            chat.appendChild(newMessage);
            chat.scrollTop = chat.scrollHeight; 
        }

        function sendMessage() {
            const message = messageInput.value;
            if (message && socket.readyState === WebSocket.OPEN) {
                socket.send(message);
                messageInput.value = '';
            } else {
                alert("Немає з'єднання з сервером");
            }
        }

        messageInput.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        });

        connect();
    </script>
</body>

</html>